#!/bin/bash

export TYPEART_TYPE_FILE="@CUCORR_YAML_DIR@/types-tealeaf.yaml"
export CUCORR_KERNEL_DATA_FILE="@CUCORR_YAML_DIR@/kernel-tealeaf.yaml"

export CUCORR_MPICXX_EXEC="@cucorr_mpicxx@"
export CUCORR_MPICC_EXEC="@cucorr_mpicc@"

touch $TYPEART_TYPE_FILE
touch $CUCORR_KERNEL_DATA_FILE


build_dir="build_cucorr"
preflag=$1
if [ ! -z "$preflag" ]; then
  export $preflag
  echo "Exported : $preflag"
  build_dir="build_vanilla"
fi


CUCORR_WRAPPER=OFF cmake . \
              -DENABLE_MPI=ON -B"${build_dir}" -DMODEL=cuda -DCUDA_ARCH=sm_70 -DCMAKE_BUILD_TYPE=Release \
              -DMODEL=cuda -DCMAKE_CUDA_COMPILER=$CUCORR_MPICXX_EXEC -DCMAKE_CXX_COMPILER=$CUCORR_MPICXX_EXEC  -DCMAKE_C_COMPILER=$CUCORR_MPICC_EXEC

cmake --build "${build_dir}" --clean-first -- -j1
